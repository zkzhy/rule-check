# 设计：输入裁剪与 ATT&CK 两阶段候选选择

## 为什么不直接把 ATT&CK.csv 全量发给 LLM
全量 CSV 体积大且 token 成本不可控，会显著挤占业务上下文空间，且不同模型对长上下文稳定性差异较大。更合理的做法是：
- 系统侧加载全量 ATT&CK.csv；
- 每条记录只抽取与该记录相关的候选子集（Top-K）注入提示词；
- 在提示词层面约束 LLM 只能从候选中选择名称。

## 两阶段候选注入的结构
提示词中增加“ATT&CK 候选列表”段落，但分两次注入：
1) 第一阶段（tactic 选择）：
- tactic 候选：若干中文战术名称（可按业务常见范围裁剪，例如优先“侦察/资源开发/初始访问”等）
2) 第二阶段（technique/sub 选择）：
- 仅注入第一阶段所选 tactic 下的 technique/sub 候选：中文规范名称
- 必要时可附带官方编号 `Txxxx` 仅作辅助展示，但输出仍要求中文名称，不输出数值 ID

候选列表格式优先采用结构化文本或轻量 JSON（实现阶段决定），目标是：
- 可读、可复制、易于 LLM 遵守
- 不超过固定 token 预算

## 候选集生成（实现阶段）
在不引入复杂依赖的前提下，采用“轻量召回 + 严格约束”：
1. 从输入记录中抽取关键词：漏洞名称、描述、PoC/证据、关键请求路径等。
2. 第一阶段候选：按配置列出 tactic 候选（规模很小，长度稳定）。
3. 第二阶段候选：在 ATT&CK.csv 的 technique_name / sub_technique_name / name_en / code_official 字段上做匹配：
   - 先做简单包含匹配（中文/英文）
   - 可选：做分词/去停用词后的模糊匹配（作为增强）
4. 排序并截取 Top-K（例如 20–50），再按 tactic 聚合展示（只展示第一阶段选中的 tactic）。

## 输入裁剪策略（实现阶段）
为了避免把整条 JSON 原样传给 LLM，引入“白名单字段 + 长度预算”：
- 白名单字段：name、description、poc/proof、req_pkg/resp_pkg（片段）、category/attack_type 等
- 单字段最大长度与总长度预算：例如总字符数 2000–4000（由配置控制）
- 对 req/resp 仅保留首/尾片段，避免重复与噪声

## 与现有提交阶段 taxonomy 的关系
本提案只改变 LLM“如何选择名称”的输入约束；提交阶段仍负责名称→ID 映射与降级策略。候选集约束能显著降低：
- LLM 输出不存在的名称导致映射失败
- 需要回退到仅 tactic 的概率
