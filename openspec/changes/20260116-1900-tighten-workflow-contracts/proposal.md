# 收敛工作流契约：路径约定、评分语义与配置错误处理

## 摘要
在不改变业务能力边界的前提下，收敛 Go 工作流的关键“契约”：中间文件路径、风险分数 1..10 语义、以及 secrets 配置的错误处理策略，减少实现与规范的漂移，降低运行时踩坑概率。

## 背景
当前工程存在几类“架构/规范不一致”与实现冗余：
- **数据文件契约不一致**：项目约定仍出现 `pending_audits_risk.jsonl`，而实现侧主输出为 `pending_audits_results.jsonl`，并且部分代码对 `paths.state_dir` 未完全生效，导致“目录可配置”名义上存在但实际使用不统一。
- **风险分语义不一致**：解析/夹逼函数在不同模块对非法值的处理不一致（例如是否允许 0、是否把缺失当 0），会影响 Submit 阶段“跳过/提交”的判定。
- **配置读取容错过度**：secrets 文件读取/反序列化失败时过度吞错，可能把真实配置问题隐藏成运行时的空值错误。
- **实现冗余**：重复的 bytes reader、重复的 id/score 规范化逻辑分散在多个包里，增加维护成本。

## 目标
1. **统一运行时路径契约**：Fetch/AI/Submit 全部遵循 `paths.state_dir`（默认 `data/`），并保持输出文件名一致。
2. **统一风险分语义**：全链路将风险分定义为 1..10；非法/缺失值在 Submit 阶段可判定为“不可提交”而不是被静默修正为 0。
3. **收紧 secrets 错误处理**：secrets 文件不存在时允许为空；文件存在但 JSON 非法时必须失败，避免吞错。
4. **减少重复代码与命名冗余**：合并重复 reader/normalize/clamp 逻辑，降低跨包重复实现。

## 非目标
- 不引入新的 AI Provider、不调整 LLM 提示词策略。
- 不改变御衡平台 API 的字段映射（除非为契约一致性所必需）。
- 不引入新的存储介质（仍以 JSONL 作为阶段边界）。

## 方案概述
- 以“契约驱动”方式调整实现：把路径、文件名、风险分与配置错误策略写入 spec，再据此实现收敛。
- 通过最小重构合并重复逻辑，优先保证行为可验证（单测/集成跑通）。

